<?xml version="1.0" encoding="utf-8" ?>
<ContentView
    x:Class="AdvancedPickerView.AdvancedPickerView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Name="Self">
    <VerticalStackLayout Padding="8" Spacing="6">
        <!--  Header estilo Picker  -->
        <Border
            x:Name="HeaderBorder"
            Padding="8"
            HeightRequest="{Binding Source={x:Reference Self}, Path=HeaderHeightRequest}"
            Stroke="{Binding Source={x:Reference Self}, Path=HeaderStroke}"
            StrokeShape="RoundRectangle 6"
            StrokeThickness="{Binding Source={x:Reference Self}, Path=HeaderStrokeThickness}">
            <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                <!--  Texto seleccionado  -->
                <Label
                    Grid.Column="0"
                    FontAutoScalingEnabled="True"
                    LineBreakMode="WordWrap"
                    MaxLines="2"
                    Text="{Binding Source={x:Reference Self}, Path=SelectedText}"
                    TextColor="{Binding Source={x:Reference Self}, Path=FilterTextColor}"
                    VerticalOptions="Center">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnToggleListClicked" />
                    </Label.GestureRecognizers>
                </Label>

                <!--  Botón lupa  -->
                <!--  Imagen con gesto en lugar de ImageButton  -->
                <Image
                    Grid.Column="1"
                    HeightRequest="{Binding Source={x:Reference Self}, Path=SearchIconHeight}"
                    HorizontalOptions="End"
                    Source="{Binding Source={x:Reference Self}, Path=SearchIconSource}"
                    WidthRequest="{Binding Source={x:Reference Self}, Path=SearchIconWidth}">
                    <Image.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnToggleListClicked" />
                    </Image.GestureRecognizers>
                </Image>
            </Grid>
        </Border>
        <!--  Panel de filtro y lista  -->
        <Border
            x:Name="FilterBorder"
            Padding="8"
            IsVisible="False"
            Stroke="LightGray"
            StrokeShape="RoundRectangle 6"
            StrokeThickness="1">

            <VerticalStackLayout Spacing="8">
                <!--  Entry de búsqueda  -->
                <Entry
                    x:Name="SearchBox"
                    ClearButtonVisibility="WhileEditing"
                    Completed="OnSearchCompleted"
                    FontSize="{Binding Source={x:Reference Self}, Path=FilterFontSize}"
                    Placeholder="{Binding Source={x:Reference Self}, Path=FilterPlaceholder}"
                    ReturnType="Search"
                    Text="{Binding Source={x:Reference Self}, Path=FilterText, Mode=TwoWay}"
                    TextChanged="OnSearchTextChanged"
                    TextColor="{Binding Source={x:Reference Self}, Path=FilterTextColor}" />

                <!--  Lista desplegable  -->
                <CollectionView
                    x:Name="FilteredList"
                    Focused="OnListFocused"
                    HeightRequest="{Binding Source={x:Reference Self}, Path=ListHeight}"
                    IsVisible="False"
                    ItemsSource="{Binding Source={x:Reference Self}, Path=FilteredItems}"
                    RemainingItemsThreshold="3"
                    RemainingItemsThresholdReached="OnRemainingItemsThresholdReached"
                    Scrolled="OnListScrolled"
                    SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <VerticalStackLayout>
                                <VerticalStackLayout.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnItemTapped" />
                                </VerticalStackLayout.GestureRecognizers>
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal">
                                            <VisualState.Setters>
                                                <Setter Property="BackgroundColor" Value="Transparent" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState Name="Selected">
                                            <VisualState.Setters>
                                                <Setter Property="BackgroundColor" Value="LightGray" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </VerticalStackLayout>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </Border>
    </VerticalStackLayout>
</ContentView>
